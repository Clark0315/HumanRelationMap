# Claude 開發需求文件

## 🎯 專案目標
開發一個 Web APP，以「心智圖 / 關係圖」的方式呈現人際關係。  
使用者能在畫布中建立節點（個人資料）、建立關聯線（關係），並支援新增、編輯、刪除、合併等操作。所有資料僅儲存在使用者本地設備，不需要伺服器端。

---

## 📌 功能需求

### 1. 節點 (Node)
- 每個節點代表一個人
- 節點顯示：
  - 名稱（文字）
  - 照片（頭像）
- 支援拖曳調整位置
- 滑鼠右鍵顯示選單（編輯、刪除）

### 2. 基本資料顯示
- 當節點被選取時，在右側詳細資訊區顯示：
  - 名稱
  - 照片
  - 電話
  - 備註

### 3. 關聯線 (Relation)
- 使用者可操作建立「節點 → 節點」的關聯
- 關聯線需顯示文字（自訂關係名稱，最長 8 個字）
- 支援滑鼠右鍵選單（編輯、刪除）

### 4. 視覺合併 (Visual Merge) ✅ **已實作**
- 右鍵點擊節點選擇「視覺合併」
- 隱藏與該節點有關係的其他節點，僅保留核心節點顯示
- 合併節點會變大（35px）並顯示為橘色主題
- 在右上角控制面板可選擇顯示群組中的哪個節點
- 支援多群組同時合併，互不影響
- 原始資料完全不變，僅改變視覺顯示

### 5. 資料合併 (Data Merge) ✅ **已實作**
- 在右側詳細資訊區選擇要合併的節點
- 合併時需選擇「以 A 的資料為主」或「以 B 的資料為主」
- 合併後，原本的關係線需更新至新節點
- 可透過 Ctrl+Z 復原合併操作

### 6. Undo / Redo ✅ **已實作**
- 對 **關聯線建立/刪除** 與 **節點合併** 支援 Undo/Redo
- 支援鍵盤快捷鍵 Ctrl+Z (復原) 和 Ctrl+Y (重做)
- 最多保留 50 步操作歷史

### 7. 匯入 / 匯出 ✅ **已實作**
- **JSON 格式**：完整的專案儲存和載入
- **CSV 匯入**：支援人員資料匯入
- **CSV 匯出**：分別匯出人員檔案和關係檔案

### 8. 儲存 / 讀取 ✅ **已實作**
- **本地儲存**：透過 JSON 檔案儲存/載入
- **自動備份**：LocalStorage 自動儲存，防止資料遺失
- **檔案操作**：完整的檔案上傳和下載功能

### 9. 使用者體驗優化 ✅ **已實作**
- **視覺設計**：圓形頭像、現代化 UI、Tailwind CSS
- **互動體驗**：
  - 滑鼠拖曳平移畫布、滾輪縮放
  - 雙向關係線曲線分離，避免重疊
  - 拖曳與點擊事件智能分離
  - 右鍵選單自動關閉
- **即時反饋**：選中節點即時更新右側資訊
- **快捷鍵**：Ctrl+Z/Y 復原重做

---

## 📐 UI 規劃

### 主畫面
- **上方 Menu Bar**：儲存、讀取、匯入、匯出 按鈕
- **左側畫布**：顯示人際關係圖
  - 節點：圓圈 + 照片
  - 關係線：箭頭線 + 關係文字
- **右側資訊區**：
  - 顯示所選節點的詳細資料（名稱、照片、電話、備註）
  - 顯示所選關係線的詳細資料（人 A、人 B、關係文字、備註）

### 新增 / 編輯 UI
- 名稱輸入框
- 照片上傳功能
- 電話輸入框
- 備註輸入框
- 關係建立區：
  - 下拉式選單（選擇另一個人）
  - 輸入關係文字（8 字內）
- 按鈕：新增 / 儲存變更、取消

### 檔案操作 UI
- **儲存**：一般檔案存檔視窗
- **讀取**：一般檔案開啟視窗
- **匯入 / 匯出**：與儲存讀取一致

---

## 🗂️ 資料結構

### Person（個人資料）
```json
{
  "id": "string (UUID)",
  "name": "string",
  "photo": "string (base64 or file path)",
  "phone": "string",
  "note": "string"
}
```

### Relation（關係線）
```json
{
  "id": "string (UUID)",
  "from": "string (Person.id)",
  "to": "string (Person.id)",
  "label": "string (max 8 chars)",
  "note": "string"
}
```

---

## 🔑 基本操作流程

1. **新增**
   - 使用者透過選單建立新節點
   - 輸入基本資料
   - 點擊「新增」 → 畫布更新顯示新節點

2. **編輯**
   - 右鍵選單 → 編輯
   - 開啟編輯 UI，修改資料後儲存
   - 畫布同步更新

3. **刪除**
   - 右鍵選單 → 刪除
   - 從資料與畫布移除該節點（及相關關係）

4. **建立/編輯關係**
   - 在節點 UI 上操作建立連線
   - 編輯 UI 輸入關係文字
   - 儲存後更新畫布

5. **合併節點**
   - 使用者選取兩個節點 → 點擊「合併」
   - 選擇保留哪一方資料
   - 更新關係並刪除被合併節點

6. **Undo / Redo**
   - 記錄操作歷史，支援恢復/重做

---

## 🚀 實際技術架構 ✅ **已採用**
- **前端框架**：React 18 + D3.js 7.9.0
- **UI 框架**：Tailwind CSS 3.4.17
- **資料儲存**：LocalStorage + JSON 檔案
- **狀態管理**：React Hooks + Custom useUndoRedo Hook
- **檔案處理**：FileReader API + Blob + CSV Parser
- **建構工具**：Create React App + PostCSS

## 📁 實際專案結構 ✅ **已建立**
```
/src
 ├─ components/
 │   ├─ GraphCanvas.jsx     # 主要畫布組件 (D3.js)
 │   └─ Sidebar.jsx         # 右側資訊欄組件
 ├─ hooks/
 │   └─ useUndoRedo.js      # 復原/重做邏輯
 ├─ utils/
 │   ├─ csvParser.js        # CSV 檔案解析
 │   └─ storage.js          # LocalStorage 操作
 ├─ App.js                  # 主應用程式
 ├─ App.css                 # 樣式檔案
 └─ index.js                # 進入點
```

---

## 📊 開發完成狀態

### ✅ **已完成功能** (100%)
1. **基礎功能**：節點管理、關係管理、拖曳操作
2. **視覺合併**：群組隱藏、節點切換、多群組支援
3. **資料合併**：節點資料合併、關係重新連結
4. **檔案操作**：JSON 儲存/載入、CSV 匯入/匯出
5. **用戶體驗**：Undo/Redo、自動儲存、快捷鍵
6. **界面優化**：曲線關係線、右鍵選單、即時更新

### 🐛 **已修正問題**
- ✅ 雙向關係線重疊 → 使用哈希算法分離曲線
- ✅ 右鍵建立關係無反應 → 改善連線模式邏輯
- ✅ 左鍵點擊畫面跳動 → 優化 zoom 和拖曳行為
- ✅ 右鍵選單不會關閉 → 添加全局點擊監聽
- ✅ 拖曳與點擊衝突 → 增加最小拖曳距離判斷

### 🌐 **部署狀態**
- **Git 倉庫**：https://github.com/Clark0315/HumanRelationMap
- **本地開發**：http://localhost:3000
- **文件完整**：README.md 包含完整使用說明

---

## 🔄 **Claude 快速進入狀況指南**

### 1. **專案概況一句話**
這是一個完整的 React + D3.js 人際關係圖應用，支援視覺合併、資料管理、檔案操作等完整功能。

### 2. **當前狀態檢查指令**
```bash
cd D:\VibeCoding\HumanRelationMap\Claude\human-relation-map
npm start  # 檢查應用是否正常運行
git status # 檢查是否有未提交的變更
git log --oneline -5  # 查看最近 5 次提交
```

### 3. **核心檔案快速定位**
- **主要邏輯**：`src/App.js` (狀態管理、函數定義)
- **視覺渲染**：`src/components/GraphCanvas.jsx` (D3.js 邏輯)
- **UI 界面**：`src/components/Sidebar.jsx` (右側控制面板)
- **需求文件**：`CLAUDE.md` (本檔案)
- **使用說明**：`README.md` (用戶手冊)

### 4. **常見任務快速命令**
```bash
# 查看應用狀態
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000

# 運行測試
npm test -- --watchAll=false

# 建立生產版本
npm run build

# 提交代碼
git add . && git commit -m "功能描述" && git push origin main
```

### 5. **技術要點提醒**
- **視覺合併** vs **資料合併**：兩個不同功能，前者僅隱藏顯示，後者修改資料
- **D3.js 更新**：修改 GraphCanvas.jsx 時記得更新 useEffect 依賴項
- **狀態管理**：使用 useUndoRedo hook，所有資料變更透過 pushState()
- **檔案結構**：persons (人員) + relations (關係) 的簡單資料模型

### 6. **下次開啟時的檢查清單**
- [ ] 應用是否正常運行 (npm start)
- [ ] Git 狀態是否乾淨 (git status)
- [ ] 最新功能是否正常 (測試視覺合併)
- [ ] 文件是否同步 (CLAUDE.md、README.md)
